---
title: "Project 872"
author: "Rachael Grainger"
date: "2022-11-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r include=FALSE}
getwd()
library(dplyr)
library(plyr)
library(lubridate)
library(tidyverse)
library(lubridate)
library(sf)
library(mapview)
library(RColorBrewer)
library(readxl)
#install.packages("viridis")
library(viridis)

#add in data here

Animal_Operations <- read.csv("Project folder/Raw Data/Animal_Operation_Permits_.csv")

allplant_data <- read_excel("Project folder/Raw Data/allplant_data.xlsx")

solar_data <- read_excel("Project folder/Raw Data/solar_data.xlsx")

#refine and combine data

solar_plants_NC <- left_join(solar_data, allplant_data)
solar_plants_NC <- solar_plants_NC %>%
  select(`Utility ID`:`Winter Capacity (MW)`, `Street Address`:Longitude) %>%
  group_by(County)
View(solar_plants_NC)

library(dplyr)
hog_farms <- Animal_Operations %>%
  filter(Type == "Swine State COC") %>%
  group_by(County)


```

## Social Vulnerability Index

CDC's Social Vulnerability Index data will be used to compare areas in North Carolina. 
Social Vulnerability Data: - <https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/SVI_documentation_2018.html> - <https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf>

Brief notes: - "E\_" are estimates; "M\_" are margins of error - "EP\_ are estimates, in percentages - "SPL_THEME1" is sum of series - "RPL_THEME1" is percentile ranking

We'll focus on just a few variables: Estimates of people in poverty ("E_POV") and of minority population ("E_MINRTY"), keeping the location attributes as well.

```{r join.attributes.to.spatial features, out.width = '100%'}

#Read the 2018 SVI county-level dataset for NC
svi2018_nc_raw <- read.csv(
  'https://svi.cdc.gov/Documents/Data/2018_SVI_Data/CSV/States_Counties/NorthCarolina_COUNTY.csv',
  colClasses = c('FIPS' = 'factor')) %>% 
  select(COUNTY, FIPS, LOCATION, E_TOTPOP, E_POV, E_MINRTY)
#Check structure
str(svi2018_nc_raw)

##create counties
counties_sf<- st_read('Project folder/Spatial/cb_2018_us_county_20m.shp') %>% 
  filter(STATEFP == 37) #Filter for just NC Counties

#Join the SVI attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = svi2018_nc_raw, 
                           by.x = "GEOID", 
                           by.y = "FIPS" )

#Tidyverse version of the join
counties_sf_join <- counties_sf %>% 
  left_join(svi2018_nc_raw, by = c("GEOID" = "FIPS") )



#View with mapview
library(leaflet)
counties_sf_join_converted <- st_transform(counties_sf_join, c=4326)

##get percents of poverty
counties_percent <- counties_sf_join_converted %>% group_by(LOCATION) %>% mutate(
                                  PovertyPerc=E_POV/E_TOTPOP, MinorityPerc=E_MINRTY/E_TOTPOP)



##Create maps



## PERCENT IN POVERTY MAP BY COUNTY
qpal = colorNumeric(palette = "plasma", counties_sf_join_converted$PovertyPerc, reverse = TRUE)

countymap_poverty <- leaflet(counties_percent) %>%
  addPolygons(stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(PovertyPerc),weight = 1) %>%
  addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=10))  %>%
  addLegend("bottomright", values=~PovertyPerc*100,pal=qpal,title="Percent in Poverty", labFormat = labelFormat(suffix = "%"), opacity = 1)

countymap_poverty

## PERCENT MINORITY MAP BY COUNTY
qpal = colorNumeric( palette = "plasma", domain = counties_sf_join_converted$MinorityPerc, reverse = TRUE)

countymap_minority <- leaflet(counties_percent) %>%
  addPolygons(stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(MinorityPerc),weight = 1) %>%
  addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=10)) %>%
  addLegend("bottomright", values=~MinorityPerc*100,pal=qpal,title="Percent Minority", labFormat = labelFormat(suffix = "%"), opacity = 1)

countymap_minority


```


```{r correlations}

#Prepare data for correlation testing

Hog_SVI_merge <- hog_farms %>%
  left_join(counties_percent, by = c("County" = "COUNTY") )

#cor.test(Hog_SVI_merge$PovertyPerc, Hog_SVI_merge$)

Solar_SVI_merge <- solar_plants_NC %>%
  left_join(counties_percent, by = c("County" = "COUNTY"))

#Correlation of Solar Farm Capacity and Poverty Level

cor.test(Solar_SVI_merge$PovertyPerc, Solar_SVI_merge$`Nameplate Capacity (MW)`) 

Solar_SVI_merge %>%
  group_by(County) %>%
  summarize(cor=cor(PovertyPerc, `Nameplate Capacity (MW)`))
#compare correlation when grouped by county and when not

#Correlation of Solar Farm Capacity and Minority Level
cor.test(Solar_SVI_merge$MinorityPerc, Solar_SVI_merge$`Nameplate Capacity (MW)`) 

Solar_SVI_merge %>%
  group_by(County) %>%
  summarize(cor=cor(MinorityPerc, `Nameplate Capacity (MW)`))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r hog farm map, out.width = '100%'}

##Convert hog farm data
       
hog_farms.sf  <- hog_farms %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
           crs=4326)

hog_farms.sf2 <- hog_farms.sf %>% drop_na(X)

##Map Hog Farms
##Add Counties Hog Farms
qpal2 = colorNumeric( palette = "plasma", domain = counties_sf_join_converted$MinorityPerc, reverse = TRUE)
qpal3 = colorNumeric( palette = "plasma", domain = counties_sf_join_converted$PovertyPerc, reverse = TRUE)
qpal <- colorNumeric(palette = "plasma", domain = counties_sf_join_converted$PovertyPerc, reverse = TRUE)
paltype <- colorFactor(
   palette = "#ffe9e3",
   domain = hog_farms.sf2$Type)

hog_farm_map1 <- leaflet() %>% 
  addPolygons(data =counties_percent, stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(MinorityPerc),weight = 1) %>%
   addLegend("topright", data = hog_farms.sf2, pal=paltype, values=~Type,title="Farm Type") %>%
    addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=14))  %>%
    addLabelOnlyMarkers(data = hog_farms.sf2, label = ~Facility) %>%
  addLegend("bottomright", data=counties_percent, values=~MinorityPerc*100,pal=qpal2,title="Percent Minority", labFormat = labelFormat(suffix = "%"), opacity = 1) %>%
  addCircleMarkers(data = hog_farms.sf2, radius = 3, color = "black", stroke = TRUE, weight = 1, fillOpacity = 0.8, fillColor = "#ffe9e3")

hog_farm_map1


##POVERTY HOG FARMS

hog_farm_map_pov <- leaflet() %>% 
  addPolygons(data =counties_percent, stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal3(PovertyPerc),weight = 1) %>%
   addLegend("topright", data = hog_farms.sf2, pal=paltype, values=~Type,title="Farm Type") %>%
    addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=14))  %>%
    addLabelOnlyMarkers(data = hog_farms.sf2, label = ~Facility) %>%
  addLegend("bottomright", data=counties_percent, values=~PovertyPerc*100,pal=qpal3,title="Percent in Poverty", labFormat = labelFormat(suffix = "%"), opacity = 1) %>%
  addCircleMarkers(data = hog_farms.sf2, radius = 3, color = "black", stroke = TRUE, weight = 1, fillOpacity = 0.8, fillColor = "#ffe9e3")

hog_farm_map_pov


```

```{r solar farm maps, out.width = '100%'}

##Convert data to spatial
       
solar_plants_NC.sf  <- solar_plants_NC %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
           crs=4326)

##Map Solar Farms with County Demographics

##Solar Minority WIHTOUT HOG FARMS

paltype_solar <- colorFactor(
   palette = "#c9ffc7",
   domain = solar_plants_NC.sf$Technology)

solar_map1 <- leaflet() %>% 
  addLegend(data = solar_plants_NC.sf, values=~Technology,pal=paltype_solar,title="Solar Farm Type" ) %>%
  addPolygons(data =counties_percent, stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(MinorityPerc),weight = 1) %>%
    addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=14))  %>%
addLegend("bottomright", data=counties_percent, values=~MinorityPerc*100,pal=qpal2,title="Percent Minority", labFormat = labelFormat(suffix = "%"), opacity = 1)  %>%
  addCircleMarkers(data = solar_plants_NC.sf, radius = 3, color = "black", stroke = TRUE, weight = 1, fillOpacity = 0.8, fillColor = "#c9ffc7")

solar_map1

##Solar + POVERTY WIHTOUT HOG FARMS



solar_map_pov <- leaflet() %>% 
  addLegend(data = solar_plants_NC.sf, values=~Technology,pal=paltype_solar,title="Solar Farm Type" ) %>%
  addPolygons(data =counties_percent, stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal3(PovertyPerc),weight = 1) %>%
    addProviderTiles("Esri.WorldGrayCanvas",
        options = providerTileOptions(minZoom=6, maxZoom=14))  %>%
addLegend("bottomright", data=counties_percent, values=~PovertyPerc*100,pal=qpal3,title="Percent in Poverty", labFormat = labelFormat(suffix = "%"), opacity = 1)  %>%
  addCircleMarkers(data = solar_plants_NC.sf, radius = 3, color = "black", stroke = TRUE, weight = 1, fillOpacity = 0.8, fillColor = "#c9ffc7")

solar_map_pov


```



