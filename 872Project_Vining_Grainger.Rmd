---
title: "Project 872"
author: "Rachael Grainger"
date: "2022-11-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r include=FALSE}
#load packages
setwd("~/R/vininggrainger872")

install.packages(dplyr)
library(dplyr)
library(plyr)
library(lubridate)
library(tidyverse)
library(lubridate)
library(sf)
library(mapview)
library(RColorBrewer)
library(readxl)

#add in data here

Animal_Operations <- read.csv("Project folder/Raw Data/Animal_Operation_Permits_.csv")


allplant_data <- read_excel("Project folder/Raw Data/allplant_data.xlsx")
View(allplant_data)

solar_data <- read_excel("Project folder/Raw Data/solar_data.xlsx")
View(solar_data)

#refine and combine data

solar_plants_NC <- left_join(solar_data, allplant_data)
library(dplyr)
hog_farms <- Animal_Operations %>%
  filter(Type == "Swine State COC")


```

## Social Vulnerability Index

CDC's Social Vulnerability Index data will be used to compare areas in North Carolina. 
Social Vulnerability Data: - <https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/SVI_documentation_2018.html> - <https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2018Documentation-H.pdf>

Brief notes: - "E\_" are estimates; "M\_" are margins of error - "EP\_ are estimates, in percentages - "SPL_THEME1" is sum of series - "RPL_THEME1" is percentile ranking

We'll focus on just a few variables: Estimates of people in poverty ("E_POV") and of minority population ("E_MINRTY"), keeping the location attributes as well.

```{r join.attributes.to.spatial features}

#Read the 2018 SVI county-level dataset for NC
svi2018_nc_raw <- read.csv(
  'https://svi.cdc.gov/Documents/Data/2018_SVI_Data/CSV/States_Counties/NorthCarolina_COUNTY.csv',
  colClasses = c('FIPS' = 'factor')) %>% 
  select(COUNTY, FIPS, LOCATION, E_TOTPOP, E_POV, E_MINRTY)
#Check structure
str(svi2018_nc_raw)

##create counties
counties_sf<- st_read('~/vininggrainger872/Project folder/Spatial/cb_2018_us_county_20m.shp') %>% 
  filter(STATEFP == 37) #Filter for just NC Counties

#Join the SVI attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = svi2018_nc_raw, 
                           by.x = "GEOID", 
                           by.y = "FIPS" )

#Tidyverse version of the join
counties_sf_join <- counties_sf %>% 
  left_join(svi2018_nc_raw, by = c("GEOID" = "FIPS") )



#View with mapview
library(leaflet)
counties_sf_join_converted <- st_transform(counties_sf_join, c=4326)

##get percents of poverty
counties_percent <- counties_sf_join_converted %>% group_by(LOCATION) %>% mutate(
                                  PovertyPerc=E_POV/E_TOTPOP, MinorityPerc=E_MINRTY/E_TOTPOP)

##Create maps

## PERCENT IN POVERTY MAP BY COUNTY
qpal = colorBin("Reds", counties_sf_join_converted$PovertyPerc, bins=9)

countymap_poverty <- leaflet(counties_percent) %>%
  addPolygons(stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(PovertyPerc),weight = 1) %>%
  addLegend(values=~PovertyPerc,pal=qpal,title="Percent in Poverty")

countymap_poverty

## PERCENT MINORITY MAP BY COUNTY
qpal = colorBin("Reds", counties_sf_join_converted$MinorityPerc, bins=9)

countymap_minority <- leaflet(counties_percent) %>%
  addPolygons(stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(MinorityPerc),weight = 1) %>%
  addLegend(values=~MinorityPerc,pal=qpal,title="Percent Minority")

countymap_minority


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r hog farm map}

##Convert hog farm data
       
hog_farms.sf  <- hog_farms %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
           crs=4326)

##Map Hog Farms

hog_farm_map <- leaflet(hog_farms.sf) %>%
  addCircleMarkers(radius = 1, color = "red", stroke = FALSE, fillOpacity = 0.5) %>%
  addLegend(values=~Type,pal=qpal,title="Farm Type") %>%
 
  
   countymap_minority

hog_farm_map

##Add Counties Hog Farms

hog_farm_map2 <- leaflet() %>%
  addCircleMarkers(data = hog_farms.sf, radius = 1, color = "red", stroke = FALSE, fillOpacity = 0.8) %>%
  addLegend(data = hog_farms.sf, values=~Type,pal=qpal,title="Farm Type") %>%
  addPolygons(data =counties_percent, stroke = TRUE,opacity = 1,fillOpacity = 0.5, smoothFactor = 0.5,
              color="black",fillColor = ~qpal(MinorityPerc),weight = 1) %>%
  addLegend(data =counties_percent, values=~MinorityPerc,pal=qpal,title="Percent Minority")

hog_farm_map2 

```
